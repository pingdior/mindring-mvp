name: Deploy MindRing to Aliyun Server

on:
  push:
    branches: [ main, master ]
    paths:
      - 'web/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'web/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js (if needed for build)
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies and build (if needed)
      run: |
        # å¦‚æžœæœ‰æž„å»ºæ­¥éª¤ï¼Œåœ¨è¿™é‡Œæ·»åŠ 
        # cd web && npm install && npm run build
        echo "No build step required for static site"
        
    - name: Prepare deployment files
      run: |
        # åˆ›å»ºéƒ¨ç½²åŒ…
        cd web
        tar -czf ../mindring-web.tar.gz .
        
    - name: Deploy to Aliyun Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/mindring-deploy
          
    - name: Upload files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        source: "mindring-web.tar.gz"
        target: "/tmp/mindring-deploy/"
        
    - name: Deploy and restart services
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          # è®¾ç½®å˜é‡
          DEPLOY_DIR="/var/www/mindring"
          BACKUP_DIR="/var/backups/mindring"
          NGINX_SITE="mindring"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # åˆ›å»ºå¤‡ä»½
          sudo mkdir -p $BACKUP_DIR
          if [ -d "$DEPLOY_DIR" ]; then
            sudo cp -r $DEPLOY_DIR $BACKUP_DIR/mindring_backup_$TIMESTAMP
            echo "âœ… å·²å¤‡ä»½çŽ°æœ‰ç½‘ç«™åˆ° $BACKUP_DIR/mindring_backup_$TIMESTAMP"
          fi
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          sudo mkdir -p $DEPLOY_DIR
          
          # è§£åŽ‹æ–°æ–‡ä»¶
          cd /tmp/mindring-deploy
          sudo tar -xzf mindring-web.tar.gz -C $DEPLOY_DIR/
          
          # åˆ›å»ºæˆ–æ›´æ–°Nginxé…ç½® (å¦‚æžœä¸å­˜åœ¨)
          if [ ! -f "/etc/nginx/sites-available/$NGINX_SITE" ]; then
            echo "ðŸ”§ åˆ›å»ºNginxé…ç½®æ–‡ä»¶..."
            sudo tee /etc/nginx/sites-available/$NGINX_SITE > /dev/null << 'EOF'
          # MindRing (knowus.ai) Nginxé…ç½®
          server {
              listen 80;
              server_name knowus.ai www.knowus.ai;
              
              root /var/www/mindring;
              index index.html index.htm;
              
              # è®¿é—®æ—¥å¿—
              access_log /var/log/nginx/mindring_access.log;
              error_log /var/log/nginx/mindring_error.log;
              
              # é™æ€æ–‡ä»¶ç¼“å­˜ä¼˜åŒ–
              location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
                  add_header Vary Accept-Encoding;
              }
              
              location ~* \.(css|js)$ {
                  expires 1M;
                  add_header Cache-Control "public";
                  add_header Vary Accept-Encoding;
              }
              
              # å­—ä½“æ–‡ä»¶
              location ~* \.(woff|woff2|ttf|eot)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
                  add_header Access-Control-Allow-Origin "*";
              }
              
              # ä¸»é¡µé¢è·¯ç”±
              location / {
                  try_files $uri $uri/ /index.html;
                  
                  # å®‰å…¨å¤´
                  add_header X-Frame-Options "SAMEORIGIN" always;
                  add_header X-Content-Type-Options "nosniff" always;
                  add_header X-XSS-Protection "1; mode=block" always;
                  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
              }
              
              # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
              location ~ /\. {
                  deny all;
                  access_log off;
                  log_not_found off;
              }
    
          # ç¦æ­¢è®¿é—®å¤‡ä»½æ–‡ä»¶
          location ~* \.(bak|backup|old|orig|original|tmp)$ {
              deny all;
              access_log off;
              log_not_found off;
          }
          
          # GzipåŽ‹ç¼©
          gzip on;
          gzip_vary on;
          gzip_min_length 1024;
          gzip_comp_level 6;
          gzip_types
              text/plain
              text/css
              text/xml
              text/javascript
              application/javascript
              application/xml+rss
              application/json
              image/svg+xml;
           }
          EOF
            
            # å¯ç”¨ç«™ç‚¹
            sudo ln -sf /etc/nginx/sites-available/$NGINX_SITE /etc/nginx/sites-enabled/
            echo "âœ… Nginxé…ç½®å·²åˆ›å»ºå¹¶å¯ç”¨"
          else
            echo "â„¹ï¸  Nginxé…ç½®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          fi
          
          # è®¾ç½®æ­£ç¡®çš„æƒé™
          sudo chown -R www-data:www-data $DEPLOY_DIR
          sudo chmod -R 755 $DEPLOY_DIR
          
          # æµ‹è¯•nginxé…ç½®
          echo "ðŸ§ª æµ‹è¯•Nginxé…ç½®..."
          sudo nginx -t
          
          # å¦‚æžœé…ç½®æ­£ç¡®ï¼Œé‡æ–°åŠ è½½nginx
          if [ $? -eq 0 ]; then
            sudo systemctl reload nginx
            echo "âœ… Nginxé…ç½®æµ‹è¯•é€šè¿‡ï¼Œå·²é‡æ–°åŠ è½½"
          else
            echo "âŒ Nginxé…ç½®æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
            exit 1
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/mindring-deploy
          
          # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
          sudo find $BACKUP_DIR -name "mindring_backup_*" -type d | sort -r | tail -n +6 | sudo xargs rm -rf
          
          echo "ðŸŽ‰ MindRingç½‘ç«™éƒ¨ç½²å®Œæˆï¼"
          echo "ðŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ðŸŒ è®¿é—®åœ°å€: http://knowus.ai (HTTP)"
          echo "ðŸ’¡ æç¤º: é…ç½®SSLè¯ä¹¦åŽå¯å¯ç”¨HTTPS"